<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHAKALIZATOR v2.0 // NUCLEAR CORE</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- CORE DESIGN --- */
        :root {
            --crt-color: #4af626; 
            --crt-alert: #ff3333;
            --bg-color: #050505;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--crt-color);
            font-family: 'VT323', monospace;
            font-size: 18px;
            text-transform: uppercase;
            overflow-x: hidden;
            user-select: none;
        }

        /* --- CRT OVERLAY --- */
        body::before {
            content: " ";
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* --- UI ELEMENTS --- */
        .bios-container {
            max-width: 950px;
            margin: 0 auto 50px auto;
            border: 4px solid var(--crt-color);
            padding: 20px;
            box-shadow: 0 0 15px var(--crt-color);
            position: relative;
            z-index: 10;
        }

        h1 {
            text-align: center;
            border-bottom: 2px dashed var(--crt-color);
            margin: 0 0 20px 0;
            font-size: 32px;
            text-shadow: 2px 2px var(--crt-alert);
        }

        .section {
            margin-bottom: 25px;
            border: 1px solid var(--crt-color);
            padding: 15px;
            background: rgba(0, 20, 0, 0.3);
        }
        .section-title {
            background: var(--crt-color);
            color: #000;
            display: inline-block;
            padding: 2px 10px;
            margin-top: -25px;
            margin-left: -5px;
            font-weight: bold;
            font-size: 20px;
        }

        /* --- CONTROLS --- */
        .control-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .control-label { flex: 1; text-shadow: 0 0 5px var(--crt-color); }
        .control-input { flex: 2; display: flex; align-items: center; }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #222;
            border: 1px solid var(--crt-color);
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--crt-color);
            cursor: crosshair;
            box-shadow: 0 0 10px var(--crt-color);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--crt-color);
            cursor: crosshair;
            border: none;
        }

        /* Красные слайдеры для опасных зон */
        .danger-slider input[type="range"]::-webkit-slider-thumb { background: var(--crt-alert); box-shadow: 0 0 10px var(--crt-alert); }
        .danger-slider input[type="range"] { border-color: var(--crt-alert); }

        .value-display { min-width: 70px; text-align: right; margin-left: 10px; font-weight: bold; }

        /* --- EQ --- */
        .eq-container { display: flex; justify-content: space-around; height: 160px; align-items: flex-end; }
        .eq-band { display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: space-between; }
        .eq-band input[type="range"] {
            writing-mode: bt-lr; 
            -webkit-appearance: slider-vertical;
            width: 20px; height: 120px;
        }

        /* --- BUTTONS --- */
        .btn {
            background: #000;
            color: var(--crt-color);
            border: 2px solid var(--crt-color);
            padding: 10px 25px;
            font-family: inherit;
            font-size: 20px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: 0.1s;
        }
        .btn:hover:not(:disabled) {
            background: var(--crt-color);
            color: #000;
            box-shadow: 0 0 20px var(--crt-color);
        }
        .btn:disabled { border-color: #333; color: #333; cursor: not-allowed; }
        
        .btn-danger { color: var(--crt-alert); border-color: var(--crt-alert); }
        .btn-danger:hover { background: var(--crt-alert); color: #000; box-shadow: 0 0 20px var(--crt-alert); }

        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        /* --- VIDEO AREA --- */
        #videoContainer {
            margin-top: 20px;
            border: 2px dashed #333;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }
        canvas { max-width: 100%; height: auto; box-shadow: 0 0 20px rgba(0,0,0,0.8); }

        /* --- FOOTER --- */
        .footer {
            margin-top: 30px;
            border-top: 1px dashed var(--crt-color);
            padding-top: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            opacity: 0.8;
        }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

    </style>
</head>
<body>

<div class="bios-container">
    <h1>/// SHAKALIZATOR v2.0 NUCLEAR ///</h1>
    
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 16px;">
        <span>SYSTEM: ONLINE</span>
        <span>MEM: 666KB OK</span>
        <span id="sysStatus">WAITING FOR INPUT...</span>
    </div>

    <div class="section">
        <div class="section-title">[ 1. LOAD DATA ]</div>
        <div class="file-input-wrapper">
            <button class="btn">[ UPLOAD FILE ]</button>
            <input type="file" id="fileInput" accept="audio/*,video/*">
        </div>
        <span id="fileName" style="margin-left: 10px; color: #888;">NO FILE</span>
        
        <div id="transport" style="margin-top: 15px; display: none;">
            <button id="playBtn" class="btn">► RUN</button>
            <button id="stopBtn" class="btn">■ HALT</button>
            <button id="randomBtn" class="btn btn-danger">[ RAND0MIZE ]</button>
        </div>
    </div>

    <div id="videoContainer">
        <div id="placeholderText" style="color: #333;">[ VISUAL OUTPUT ]</div>
        <canvas id="mainCanvas"></canvas>
        <video id="sourceVideo" style="display: none;" playsinline webkit-playsinline crossorigin="anonymous"></video>
    </div>

    <div style="height: 20px;"></div>

    <div class="section">
        <div class="section-title">[ 2. AUDIO DESTRUCTION ]</div>
        
        <div class="control-group">
            <label class="control-label">INPUT GAIN (VOLUME)</label>
            <div class="control-input">
                <input type="range" id="param-gain" min="0.5" max="5" step="0.1" value="1">
                <span class="value-display" id="val-gain">1.0</span>
            </div>
        </div>

        <div class="control-group danger-slider">
            <label class="control-label">BITCRUSHER (JPEG AUDIO)</label>
            <div class="control-input">
                <input type="range" id="param-crush" min="0" max="1" step="0.01" value="0">
                <span class="value-display" id="val-crush">0%</span>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">HARD CLIP DISTORTION</label>
            <div class="control-input">
                <input type="range" id="param-dist" min="0" max="2000" step="10" value="0">
                <span class="value-display" id="val-dist">0</span>
            </div>
        </div>

         <div class="control-group">
            <label class="control-label">DIGITAL DELAY (ECHO)</label>
            <div class="control-input">
                <input type="range" id="param-delay" min="0" max="1" step="0.05" value="0">
                <span class="value-display" id="val-delay">OFF</span>
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">PLAYBACK RATE (SPEED)</label>
            <div class="control-input">
                <input type="range" id="param-rate" min="0.1" max="3" step="0.1" value="1">
                <span class="value-display" id="val-rate">1.0x</span>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">[ 3. FREQUENCY MAP ]</div>
        <div class="eq-container">
            <div class="eq-band"><input type="range" class="eq-sl" data-f="0" min="-20" max="20" value="0"><label>LOW</label></div>
            <div class="eq-band"><input type="range" class="eq-sl" data-f="1" min="-20" max="20" value="0"><label>MID</label></div>
            <div class="eq-band"><input type="range" class="eq-sl" data-f="2" min="-20" max="20" value="0"><label>HIGH</label></div>
            <div class="eq-band"><input type="range" class="eq-sl" data-f="3" min="-20" max="20" value="0"><label>ULTRA</label></div>
            <div class="eq-band"><input type="range" class="eq-sl" data-f="4" min="-20" max="20" value="0"><label>AIR</label></div>
        </div>
    </div>

    <div class="section" id="vidControls" style="display:none;">
        <div class="section-title">[ 4. VISUAL CORRUPTION ]</div>
        <div class="control-group danger-slider">
            <label class="control-label">RGB SPLIT LEVEL</label>
            <div class="control-input">
                <input type="range" id="v-rgb" min="0" max="50" value="0">
                <span class="value-display" id="val-v-rgb">0</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">CONTRAST FRYING</label>
            <div class="control-input">
                <input type="range" id="v-contrast" min="100" max="500" value="100">
                <span class="value-display" id="val-v-contrast">100%</span>
            </div>
        </div>
    </div>

    <div class="section" style="border-color: #fff;">
        <div class="section-title" style="background: #fff;">[ 5. EXPORT ]</div>
        <button id="recBtn" class="btn btn-danger">● START RECORDING</button>
        <span id="recStatus" class="blink" style="display:none; color: red;">[ REC IN PROGRESS ]</span>
        <div style="font-size: 12px; margin-top: 5px; color: #666;">*Note: Recording relies on browser capabilities. May lag on heavy settings.*</div>
    </div>

    <div class="footer">
        <div>@Dicko1Prim | 2026.</div>
        <div>NO WARRANTY. USE AT OWN RISK.</div>
    </div>

</div>

<script>
/* =========================================
   CORE SYSTEM LOGIC
   ========================================= */

const sysStatus = document.getElementById('sysStatus');
const fileInput = document.getElementById('fileInput');
const videoElement = document.getElementById('sourceVideo');
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true }); // Opt for speed
const transport = document.getElementById('transport');
const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('stopBtn');

// --- AUDIO CONTEXT VARS ---
let actx;
let sourceNode;
let gainNode, distortionNode, delayNode, feedbackNode, limiterNode;
let bitcrusherNode; // ScriptProcessor
let eqNodes = [];
let destStream;
let isPlaying = false;
let isVideo = false;

// --- RECORDER VARS ---
let mediaRecorder;
let chunks = [];
let animationId;

// --- INITIALIZE UI EVENTS ---
fileInput.addEventListener('change', handleFileSelect);
playBtn.addEventListener('click', startSystem);
stopBtn.addEventListener('click', stopSystem);
document.getElementById('recBtn').addEventListener('click', toggleRecording);
document.getElementById('randomBtn').addEventListener('click', randomizeSettings);

// Sliders listeners
const bindSlider = (id, displayId, unit = '', cb) => {
    const el = document.getElementById(id);
    el.addEventListener('input', (e) => {
        document.getElementById(displayId).innerText = e.target.value + unit;
        if(cb) cb(parseFloat(e.target.value));
    });
};

bindSlider('param-gain', 'val-gain', '', v => { if(gainNode) gainNode.gain.value = v; });
bindSlider('param-dist', 'val-dist', '', v => updateDistortion(v));
bindSlider('param-rate', 'val-rate', 'x', v => { videoElement.playbackRate = v; });
bindSlider('param-delay', 'val-delay', '', v => updateDelay(v));
bindSlider('param-crush', 'val-crush', '%', v => {}); // Handled in processor
bindSlider('v-rgb', 'val-v-rgb');
bindSlider('v-contrast', 'val-v-contrast', '%');

// EQ Listeners
const freqs = [60, 250, 1000, 4000, 12000];
document.querySelectorAll('.eq-sl').forEach((el, idx) => {
    el.addEventListener('input', (e) => {
        if(eqNodes[idx]) eqNodes[idx].gain.value = e.target.value;
    });
});

/* =========================================
   FILE LOADING
   ========================================= */
function handleFileSelect(e) {
    const file = e.target.files[0];
    if(!file) return;

    // Reset
    stopSystem();
    
    document.getElementById('fileName').innerText = file.name;
    sysStatus.innerText = "LOADING DATA...";
    sysStatus.style.color = "yellow";

    const url = URL.createObjectURL(file);
    videoElement.src = url;
    
    isVideo = file.type.startsWith('video');
    
    videoElement.onloadeddata = () => {
        sysStatus.innerText = "READY TO RUN";
        sysStatus.style.color = "var(--crt-color)";
        transport.style.display = "block";
        
        if(isVideo) {
            document.getElementById('vidControls').style.display = "block";
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            // Draw first frame
            ctx.drawImage(videoElement, 0, 0);
            document.getElementById('placeholderText').style.display = 'none';
        } else {
            document.getElementById('vidControls').style.display = "none";
            canvas.width = 320;
            canvas.height = 100;
            ctx.fillStyle = "#000";
            ctx.fillRect(0,0,320,100);
            ctx.fillStyle = "#4af626";
            ctx.font = "20px monospace";
            ctx.fillText("AUDIO ONLY MODE", 80, 55);
            document.getElementById('placeholderText').style.display = 'none';
        }
    };
}

/* =========================================
   AUDIO ENGINE
   ========================================= */
function initAudio() {
    if(!actx) actx = new (window.AudioContext || window.webkitAudioContext)();
    actx.resume();

    // 1. Create Nodes
    // Fix: createMediaElementSource can only be created once per element
    if(!sourceNode) {
        sourceNode = actx.createMediaElementSource(videoElement);
    }

    gainNode = actx.createGain();
    
    // Distortion
    distortionNode = actx.createWaveShaper();
    updateDistortion(document.getElementById('param-dist').value);

    // Bitcrusher (ScriptProcessor - old but effective for glitching)
    // Buffer size 4096 gives a nice laggy feel if we mess with it
    bitcrusherNode = actx.createScriptProcessor(4096, 2, 2);
    bitcrusherNode.onaudioprocess = processBitcrush;

    // EQ
    eqNodes = freqs.map(f => {
        const n = actx.createBiquadFilter();
        n.type = "peaking";
        n.frequency.value = f;
        n.Q.value = 1;
        return n;
    });

    // Delay
    delayNode = actx.createDelay(5.0);
    feedbackNode = actx.createGain();
    delayNode.delayTime.value = 0; 
    feedbackNode.gain.value = 0;

    // Limiter (Protects ears slightly)
    limiterNode = actx.createDynamicsCompressor();
    limiterNode.threshold.value = -5;
    limiterNode.ratio.value = 20;

    destStream = actx.createMediaStreamDestination();

    // 2. Connect Graph
    // Source -> Gain -> Bitcrusher -> Distortion -> EQ -> Delay -> Limiter -> Out
    
    let c = sourceNode;
    c.connect(gainNode); c = gainNode;
    
    c.connect(bitcrusherNode); c = bitcrusherNode;
    
    c.connect(distortionNode); c = distortionNode;
    
    eqNodes.forEach(n => { c.connect(n); c = n; });

    // Delay path
    c.connect(delayNode);
    delayNode.connect(feedbackNode);
    feedbackNode.connect(delayNode); // loop
    delayNode.connect(limiterNode); // wet signal
    c.connect(limiterNode); // dry signal

    limiterNode.connect(actx.destination);
    limiterNode.connect(destStream);
}

// Custom Bitcrusher Logic
function processBitcrush(e) {
    const crushAmount = parseFloat(document.getElementById('param-crush').value);
    const input = e.inputBuffer;
    const output = e.outputBuffer;

    // If crush is 0, pass through roughly
    if(crushAmount <= 0.01) {
        for (let ch = 0; ch < input.numberOfChannels; ch++) {
            output.getChannelData(ch).set(input.getChannelData(ch));
        }
        return;
    }

    const step = Math.pow(0.5, (1 - crushAmount) * 16); // Simulate bit depth
    const sampleRateFactor = 1 + (crushAmount * 50); // Simulate sample rate reduction

    for (let channel = 0; channel < input.numberOfChannels; channel++) {
        const inputData = input.getChannelData(channel);
        const outputData = output.getChannelData(channel);

        for (let i = 0; i < inputData.length; i++) {
             // Sample & Hold effect (downsampling)
            if (i % Math.floor(sampleRateFactor) !== 0) {
                outputData[i] = outputData[i-1] || 0;
                continue;
            }
            
            // Bit crushing
            let s = inputData[i];
            s = Math.round(s / step) * step;
            outputData[i] = s;
        }
    }
}

function updateDistortion(amount) {
    if(!distortionNode) return;
    const k = amount;
    const n_samples = 44100;
    const curve = new Float32Array(n_samples);
    const deg = Math.PI / 180;
    
    if(k < 1) {
        distortionNode.curve = null; 
        return;
    }

    for (let i = 0; i < n_samples; ++i) {
        const x = i * 2 / n_samples - 1;
        curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
    }
    distortionNode.curve = curve;
}

function updateDelay(val) {
    if(!delayNode) return;
    if(val <= 0.05) {
        delayNode.delayTime.value = 0;
        feedbackNode.gain.value = 0;
    } else {
        delayNode.delayTime.value = val * 0.5; // up to 0.5s
        feedbackNode.gain.value = 0.6; // fixed feedback for now
    }
}

/* =========================================
   SYSTEM CONTROL
   ========================================= */
function startSystem() {
    if(!videoElement.src) return;
    if(isPlaying) return;

    initAudio();
    videoElement.play().then(() => {
        isPlaying = true;
        sysStatus.innerText = "PROCESSING...";
        sysStatus.style.color = "#4af626";
        drawLoop();
    }).catch(e => {
        alert("ERROR: CLICK 'RUN' AGAIN. BROWSER BLOCKED AUTOPLAY.");
    });
}

function stopSystem() {
    videoElement.pause();
    videoElement.currentTime = 0;
    isPlaying = false;
    cancelAnimationFrame(animationId);
    sysStatus.innerText = "HALTED";
    sysStatus.style.color = "red";
}

function randomizeSettings() {
    // Chaos function
    document.getElementById('param-dist').value = Math.random() * 1000;
    updateDistortion(document.getElementById('param-dist').value);
    
    document.getElementById('param-rate').value = 0.5 + Math.random();
    videoElement.playbackRate = document.getElementById('param-rate').value;

    document.getElementById('v-rgb').value = Math.random() * 30;
    document.getElementById('v-contrast').value = 100 + Math.random() * 200;

    // Update displays
    ['param-dist', 'param-rate', 'v-rgb', 'v-contrast'].forEach(id => {
        document.getElementById(id).dispatchEvent(new Event('input'));
    });
}

/* =========================================
   VISUAL LOOP (CANVAS)
   ========================================= */
function drawLoop() {
    if(!isPlaying) return;
    
    if(isVideo) {
        const w = canvas.width;
        const h = canvas.height;
        
        // Settings
        const rgbOffset = parseInt(document.getElementById('v-rgb').value);
        const contrast = parseInt(document.getElementById('v-contrast').value);
        
        // 1. Draw original
        ctx.globalCompositeOperation = 'source-over';
        ctx.filter = `contrast(${contrast}%)`;
        ctx.drawImage(videoElement, 0, 0, w, h);
        ctx.filter = 'none';

        // 2. RGB Split Effect (Manual Glitch)
        if(rgbOffset > 0) {
            // Get image data
            // Note: getting ImageData every frame is heavy, but for this vibe heavy is okay
            // Optimized approach: using composite operations with slight offsets
            
            // Draw Red Channel Offset
            ctx.globalCompositeOperation = 'screen';
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = 'red';
            // Simple shake
            const dx = (Math.random() - 0.5) * rgbOffset;
            const dy = (Math.random() - 0.5) * rgbOffset;
            ctx.drawImage(videoElement, dx, dy, w, h);
            
            // Draw Blue Channel Offset
            ctx.fillStyle = 'blue';
            ctx.drawImage(videoElement, -dx, -dy, w, h);
            
            ctx.globalAlpha = 1.0;
        }

    } else {
        // Audio Visualizer placeholder
        const rgbOffset = parseInt(document.getElementById('v-rgb').value); // Use as shake
        ctx.fillStyle = `rgba(0, 0, 0, 0.1)`; // Trails
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#4af626';
        const h = canvas.height / 2;
        const dist = parseFloat(document.getElementById('param-dist').value) / 10;
        ctx.fillRect(Math.random()*canvas.width, h - dist, 5, dist*2);
    }

    animationId = requestAnimationFrame(drawLoop);
}

/* =========================================
   RECORDING
   ========================================= */
function toggleRecording() {
    const btn = document.getElementById('recBtn');
    const status = document.getElementById('recStatus');

    if(btn.innerText.includes("START")) {
        // Start
        const canvasStream = canvas.captureStream(30);
        const audioStream = destStream.stream;
        
        const combined = new MediaStream([
            ...canvasStream.getVideoTracks(),
            ...audioStream.getAudioTracks()
        ]);

        const opts = { mimeType: 'video/webm;codecs=vp9,opus' };
        
        try {
            mediaRecorder = new MediaRecorder(combined, opts);
        } catch(e) {
            mediaRecorder = new MediaRecorder(combined); // fallback
        }

        chunks = [];
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = saveFile;
        
        mediaRecorder.start();
        btn.innerText = "■ STOP RECORDING";
        status.style.display = "inline";
    } else {
        // Stop
        mediaRecorder.stop();
        btn.innerText = "● START RECORDING";
        status.style.display = "none";
    }
}

function saveFile() {
    const blob = new Blob(chunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `shakal_export_${Date.now()}.webm`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
}

</script>
</body>
</html>
