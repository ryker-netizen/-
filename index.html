<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GLITCH MONSTER</title>

<style>
body{
  background:#000;
  color:#fff;
  margin:0;
  font-family:sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
}

#panel{
  position:fixed;
  top:0;
  left:0;
  right:0;
  background:#000;
  padding:10px;
  z-index:10;
}

canvas{
  margin-top:170px;
  max-width:100%;
  height:auto;
  background:#000;
}

button,input{margin:4px;}
</style>
</head>

<body>

<div id="panel">
<input type="file" id="file">
<button id="play">play</button>
<button id="stop">stop</button>
<button id="rec">rec</button>
<button id="download">download</button>

<br>

<label>destruction</label>
<input type="range" id="destruction" min="0" max="100">

<label>glitch</label>
<input type="range" id="glitch" min="0" max="100">

<label>volume</label>
<input type="range" id="volume" min="0" max="1" step="0.01" value="1">
</div>

<video id="video" playsinline style="display:none"></video>
<canvas id="canvas"></canvas>

<script>
const fileInput = document.getElementById("file");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const playBtn = document.getElementById("play");
const stopBtn = document.getElementById("stop");
const recBtn = document.getElementById("rec");
const downloadBtn = document.getElementById("download");

const destructionSlider = document.getElementById("destruction");
const glitchSlider = document.getElementById("glitch");
const volumeSlider = document.getElementById("volume");

let destruction = 0;
let glitch = 0;

let recorder;
let chunks = [];
let recording=false;

fileInput.onchange = e=>{
  const file = e.target.files[0];
  video.src = URL.createObjectURL(file);
};

video.onloadedmetadata = ()=>{

  // сохраняем вертикаль правильно
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

};

playBtn.onclick = ()=>{
  video.play();
  draw();
};

stopBtn.onclick = ()=>{
  video.pause();
};

volumeSlider.oninput = e=>{
  video.volume = e.target.value;
};

destructionSlider.oninput = e=>{
  destruction = e.target.value/100;
};

glitchSlider.oninput = e=>{
  glitch = e.target.value/100;
};

function draw(){
  if(video.paused || video.ended) return;

  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  if(destruction>0 || glitch>0){

    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = img.data;

    for(let i=0;i<data.length;i+=4){
      if(Math.random()<destruction*0.06){
        data[i]=255;
        data[i+1]=Math.random()*255;
        data[i+2]=Math.random()*255;
      }
    }

    for(let y=0;y<canvas.height;y++){
      if(Math.random()<glitch*0.12){
        const shift=(Math.random()*120-60)|0;
        const row=ctx.getImageData(0,y,canvas.width,1);
        ctx.putImageData(row,shift,y);
      }
    }

    ctx.putImageData(img,0,0);
  }

  requestAnimationFrame(draw);
}

recBtn.onclick = ()=>{

  if(!recording){

    chunks=[];

    const stream = canvas.captureStream(30);
    recorder = new MediaRecorder(stream,{mimeType:"video/webm"});

    recorder.ondataavailable = e=>{
      if(e.data.size>0) chunks.push(e.data);
    };

    recorder.onstop = ()=>{
      const blob = new Blob(chunks,{type:"video/webm"});
      const url = URL.createObjectURL(blob);

      downloadBtn.onclick = ()=>{
        const a = document.createElement("a");
        a.href = url;
        a.download = "glitch.webm";
        a.click();
      };
    };

    recorder.start();
    recording=true;
    recBtn.textContent="stop rec";

  }else{

    recorder.stop();
    recording=false;
    recBtn.textContent="rec";

  }

};
</script>

</body>
</html>
