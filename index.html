<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ШАКАЛИЗАТОР v1.0 // BIOS SETUP</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- BIOS / CRT DESIGN --- */
        :root {
            --crt-color: #4af626; /* Ядовито-зеленый терминал */
            --bg-color: #111;
            --crt-flicker: 0.97;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: #000;
            color: var(--crt-color);
            font-family: 'VT323', monospace;
            font-size: 18px;
            text-transform: uppercase;
            overflow-x: hidden;
            position: relative;
        }

        /* Эффект ЭЛТ монитора (сканлайны и мерцание) */
        body::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
        body::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: 0;
            z-index: 2;
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }
        @keyframes flicker {
            0% { opacity: 0.27861; }
            5% { opacity: 0.34769; }
            10% { opacity: 0.23604; }
            15% { opacity: 0.90626; }
            20% { opacity: 0.18128; }
            25% { opacity: 0.83891; }
            30% { opacity: 0.65583; }
            35% { opacity: 0.67807; }
            40% { opacity: 0.26559; }
            45% { opacity: 0.84693; }
            50% { opacity: 0.96019; }
            55% { opacity: 0.08594; }
            60% { opacity: 0.20313; }
            65% { opacity: 0.71988; }
            70% { opacity: 0.53455; }
            75% { opacity: 0.37288; }
            80% { opacity: 0.71428; }
            85% { opacity: 0.70419; }
            90% { opacity: 0.7003; }
            95% { opacity: 0.36108; }
            100% { opacity: 0.24387; }
        }

        /* --- LAYOUT --- */
        .bios-container {
            max-width: 900px;
            margin: 0 auto;
            border: 4px solid var(--crt-color);
            padding: 20px;
            box-shadow: 0 0 20px var(--crt-color);
        }

        h1 {
            text-align: center;
            border-bottom: 2px dashed var(--crt-color);
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .section {
            margin-bottom: 30px;
            border: 2px solid var(--crt-color);
            padding: 15px;
        }
        .section-title {
            background: var(--crt-color);
            color: #000;
            display: inline-block;
            padding: 2px 10px;
            margin-top: -25px;
            margin-left: 10px;
            font-weight: bold;
        }

        /* --- CONTROLS --- */
        .control-group {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-label {
            flex: 1;
            min-width: 200px;
        }
        .control-input {
            flex: 2;
            display: flex;
            align-items: center;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 15px;
            background: #222;
            border: 2px solid var(--crt-color);
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: var(--crt-color);
            cursor: pointer;
            box-shadow: 0 0 10px var(--crt-color);
        }
        input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: var(--crt-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px var(--crt-color);
        }

        .value-display {
            min-width: 60px;
            text-align: right;
            margin-left: 10px;
            color: var(--crt-color);
        }

        /* --- EQ SECTION --- */
        .eq-container {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .eq-band {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        .eq-band input[type="range"] {
            /* Поворачиваем слайдеры вертикально для EQ */
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* WebKit */
            width: 30px;
            height: 150px;
            margin: 10px 0;
        }

        /* --- MEDIA & BUTTONS --- */
        #fileInput {
            display: none;
        }
        .file-upload-btn, .action-btn {
            background: transparent;
            color: var(--crt-color);
            border: 2px solid var(--crt-color);
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 20px;
            text-transform: uppercase;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.1s;
        }
        .file-upload-btn:hover, .action-btn:hover {
            background: var(--crt-color);
            color: #000;
            box-shadow: 0 0 15px var(--crt-color);
        }
        .file-upload-btn:active, .action-btn:active {
             transform: scale(0.98);
        }

        #videoContainer {
            display: none; /* Скрыт по умолчанию */
            margin-top: 20px;
            text-align: center;
            border: 2px dashed var(--crt-color);
            padding: 5px;
        }
        canvas {
            max-width: 100%;
            height: auto;
            /* Базовый фильтр для монитора */
            filter: sepia(100%) hue-rotate(50deg) saturate(300%) contrast(120%);
        }

        .status-bar {
            margin-top: 20px;
            border-top: 2px dashed var(--crt-color);
            padding-top: 10px;
            display: flex;
            justify-content: space-between;
        }

        #recordingIndicator {
            color: red;
            display: none;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body>

<div class="bios-container">
    <h1>/// ШАКАЛИЗАТОР СИСТЕМ v2.6.6 ///</h1>
    <div style="text-align: center; margin-bottom: 20px;">
        <span style="border: 1px solid var(--crt-color); padding: 5px;">BIOS DATE: 26/01/2026</span>
        <span style="border: 1px solid var(--crt-color); padding: 5px; margin-left: 10px;">STATUS: SYSTEM CORRUPTION READY</span>
    </div>

    <div class="section">
        <div class="section-title">[ INPUT SOURCE ]</div>
        <label for="fileInput" class="file-upload-btn">
            [ LOAD FILE (AUDIO/VIDEO) ]
        </label>
        <input type="file" id="fileInput" accept="audio/*,video/*">
        <span id="fileNameDisplay">NO FILE LOADED</span>

        <div id="mediaControls" style="margin-top: 20px; display: none;">
            <button id="playBtn" class="action-btn">► PLAY</button>
            <button id="stopBtn" class="action-btn">■ STOP</button>
            <button id="startRecBtn" class="action-btn">● REC OUTPUT</button>
            <button id="stopRecBtn" class="action-btn" style="display:none; color:red; border-color:red;">■ STOP REC</button>
            <span id="recordingIndicator">RECORDING...</span>
        </div>
    </div>

    <div id="videoContainer">
        <canvas id="videoCanvas"></canvas>
        <video id="sourceVideo" style="display: none;" playsinline webkit-playsinline crossOrigin="anonymous"></video>
    </div>

    <div class="section">
        <div class="section-title">[ AUDIO DESTRUCTION CORE ]</div>
        
        <div class="control-group">
            <label class="control-label">MASTER GAIN (PRE-LIMITER)</label>
            <div class="control-input">
                <input type="range" id="preGain" min="1" max="20" step="0.1" value="1">
                <span class="value-display" id="preGainVal">1.0</span>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">DISTORTION (BITCRUSH/CLIP)</label>
            <div class="control-input">
                <input type="range" id="distortion" min="0" max="1000" step="1" value="0">
                <span class="value-display" id="distortionVal">0</span>
            </div>
        </div>

         <div class="control-group">
            <label class="control-label">BRICKWALL LIMITER (THRESHOLD)</label>
            <div class="control-input">
                <input type="range" id="limiterThresh" min="-60" max="0" step="1" value="-10">
                <span class="value-display" id="limiterThreshVal">-10dB</span>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">PLAYBACK RATE (PITCH/SPEED)</label>
            <div class="control-input">
                <input type="range" id="playbackRate" min="0.1" max="3" step="0.1" value="1">
                <span class="value-display" id="playbackRateVal">1.0x</span>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">[ 5-BAND GRAPHIC EQ (165Hz - 16kHz+) ]</div>
        <div class="eq-container">
            <div class="eq-band">
                <label>165Hz</label>
                <input type="range" class="eq-slider" data-freq="165" min="-40" max="40" value="0" orient="vertical">
                <span class="eq-val">0dB</span>
            </div>
            <div class="eq-band">
                <label>500Hz</label>
                <input type="range" class="eq-slider" data-freq="500" min="-40" max="40" value="0" orient="vertical">
                <span class="eq-val">0dB</span>
            </div>
            <div class="eq-band">
                <label>2kHz</label>
                <input type="range" class="eq-slider" data-freq="2000" min="-40" max="40" value="0" orient="vertical">
                <span class="eq-val">0dB</span>
            </div>
            <div class="eq-band">
                <label>6kHz</label>
                <input type="range" class="eq-slider" data-freq="6000" min="-40" max="40" value="0" orient="vertical">
                <span class="eq-val">0dB</span>
            </div>
            <div class="eq-band">
                <label>16kHz+</label>
                <input type="range" class="eq-slider" data-freq="16000" min="-40" max="40" value="0" orient="vertical">
                <span class="eq-val">0dB</span>
            </div>
        </div>
    </div>

     <div class="section" id="videoControlsSection" style="display:none;">
        <div class="section-title">[ VIDEO SIGNAL CORRUPTION ]</div>
        <div class="control-group">
             <label class="control-label" style="color: red;">⚠ SHAKAL LEVEL (1-10) ⚠</label>
             <div class="control-input">
                 <input type="range" id="videoShakal" min="0" max="10" step="1" value="0">
                 <span class="value-display" id="videoShakalVal">0</span>
             </div>
         </div>
         <div style="font-size: 14px; color: #888;">*Warning: High levels may cause visual seizures and browser lag.*</div>
    </div>

    <div class="status-bar">
        <div>F1: HELP | F10: SAVE & EXIT | ESC: DISCARD</div>
        <div>@Dicko1Prim | 2026.</div>
    </div>
</div>


<script>
    // === ИНИЦИАЛИЗАЦИЯ СИСТЕМЫ ===
    console.log("BIOS SYSTEM BOOT...");
    console.log("LOADING SHAKALIZATOR KERNEL...");

    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const mediaControls = document.getElementById('mediaControls');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const startRecBtn = document.getElementById('startRecBtn');
    const stopRecBtn = document.getElementById('stopRecBtn');
    const recordingIndicator = document.getElementById('recordingIndicator');

    const videoContainer = document.getElementById('videoContainer');
    const sourceVideo = document.getElementById('sourceVideo');
    const videoCanvas = document.getElementById('videoCanvas');
    const canvasCtx = videoCanvas.getContext('2d');
    const videoControlsSection = document.getElementById('videoControlsSection');
    const videoShakalSlider = document.getElementById('videoShakal');

    // --- WEB AUDIO CONTEXT ---
    let audioCtx;
    let sourceNode;
    let preGainNode;
    let distortionNode;
    let eqBands = [];
    let limiterNode;
    let masterAnalyser;
    let destinationStreamNode; // Для записи

    let isVideo = false;
    let isPlaying = false;
    let animationId;
    let mediaRecorder;
    let recordedChunks = [];

    // --- НАСТРОЙКА ЗВУКОВОГО ТРАКТА ---
    function initAudioContext() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        // 1. Pre-Gain (для перегруза)
        preGainNode = audioCtx.createGain();
        preGainNode.gain.value = parseFloat(document.getElementById('preGain').value);

        // 2. Distortion (WaveShaper для жесткого клиппинга)
        distortionNode = audioCtx.createWaveShaper();
        updateDistortionCurve(0);

        // 3. EQ (5 полос)
        const frequencies = [165, 500, 2000, 6000, 16000];
        eqBands = frequencies.map(freq => {
            const filter = audioCtx.createBiquadFilter();
            filter.type = (freq === 165) ? 'lowshelf' : (freq === 16000) ? 'highshelf' : 'peaking';
            filter.frequency.value = freq;
            filter.Q.value = 1.0; // Ширина полосы
            filter.gain.value = 0;
            return filter;
        });

        // 4. Limiter (DynamicsCompressor с экстремальными настройками)
        limiterNode = audioCtx.createDynamicsCompressor();
        limiterNode.threshold.value = parseFloat(document.getElementById('limiterThresh').value);
        limiterNode.knee.value = 0; // Жесткое колено
        limiterNode.ratio.value = 20; // Почти кирпичная стена
        limiterNode.attack.value = 0.001; // Мгновенная атака
        limiterNode.release.value = 0.1;

        // 5. Analyser (для визуализации, если понадобится, и для записи)
        masterAnalyser = audioCtx.createAnalyser();
        
        // 6. Узел для записи потока
        destinationStreamNode = audioCtx.createMediaStreamDestination();
    }

    // --- ФУНКЦИЯ СОЗДАНИЯ КРИВОЙ ДИСТОРШНА ---
    // Чем выше 'amount', тем жестче квадратная волна
    function makeDistortionCurve(amount) {
        const k = typeof amount === 'number' ? amount : 50;
        const n_samples = 44100;
        const curve = new Float32Array(n_samples);
        const deg = Math.PI / 180;
        for (let i = 0; i < n_samples; ++i) {
            const x = i * 2 / n_samples - 1;
            // Классическая формула для жесткого клиппинга
            curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
        }
        return curve;
    }

    function updateDistortionCurve(val) {
        if (!distortionNode) return;
        if (val === 0) {
            distortionNode.curve = null;
        } else {
            // Увеличиваем множитель для "супер шакала"
            distortionNode.curve = makeDistortionCurve(val * 2);
        }
    }

    // --- ЗАГРУЗКА ФАЙЛА ---
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        stopPlayback(); // Остановить предыдущее
        fileNameDisplay.textContent = "LOADED: " + file.name.toUpperCase();
        mediaControls.style.display = "block";

        isVideo = file.type.startsWith('video');

        if (isVideo) {
            videoContainer.style.display = "block";
            videoControlsSection.style.display = "block";
            sourceVideo.src = URL.createObjectURL(file);
            sourceVideo.load();
        } else {
            videoContainer.style.display = "none";
            videoControlsSection.style.display = "none";
            // Для аудио можно было бы использовать FileReader и decodeAudioData,
            // но использование video элемента для аудио тоже работает и унифицирует код.
            sourceVideo.src = URL.createObjectURL(file);
            sourceVideo.load();
        }
    });

    // --- PLAYBACK CONTROL ---
    playBtn.addEventListener('click', startPlayback);
    stopBtn.addEventListener('click', stopPlayback);

    function startPlayback() {
        if (isPlaying) return;
        initAudioContext();
        audioCtx.resume();

        // Создаем источник из элемента <video> (он играет и аудио файлы)
        sourceNode = audioCtx.createMediaElementSource(sourceVideo);

        // --- СОЕДИНЯЕМ ЦЕПЬ ЭФФЕКТОВ ---
        // Source -> PreGain -> Distortion -> EQ[0]->EQ[1]... -> Limiter -> Destination
        let currentNode = sourceNode;
        currentNode.connect(preGainNode);
        currentNode = preGainNode;
        
        currentNode.connect(distortionNode);
        currentNode = distortionNode;

        eqBands.forEach(band => {
            currentNode.connect(band);
            currentNode = band;
        });

        currentNode.connect(limiterNode);
        currentNode = limiterNode;

        currentNode.connect(masterAnalyser);
        masterAnalyser.connect(audioCtx.destination); // Выход на колонки
        masterAnalyser.connect(destinationStreamNode); // Выход на запись

        // Применяем скорость воспроизведения
        sourceVideo.playbackRate = parseFloat(document.getElementById('playbackRate').value);

        if (isVideo) {
            videoCanvas.width = sourceVideo.videoWidth || 640;
            videoCanvas.height = sourceVideo.videoHeight || 480;
            drawVideoFrame();
        }
        
        sourceVideo.play();
        isPlaying = true;
    }

    function stopPlayback() {
        if (!isPlaying) return;
        sourceVideo.pause();
        sourceVideo.currentTime = 0;
        if (sourceNode) {
            sourceNode.disconnect();
        }
        cancelAnimationFrame(animationId);
        isPlaying = false;
    }

    // --- ВИДЕО ОБРАБОТКА (КАНВАС) ---
    function drawVideoFrame() {
        if (sourceVideo.paused || sourceVideo.ended) return;

        canvasCtx.drawImage(sourceVideo, 0, 0, videoCanvas.width, videoCanvas.height);

        // Применяем эффекты шакализации видео
        const shakalLevel = parseInt(videoShakalSlider.value);
        if (shakalLevel > 0) {
             // Генерируем случайные смещения для глитч-эффекта
            const noiseX = (Math.random() - 0.5) * shakalLevel * 5;
            const noiseY = (Math.random() - 0.5) * shakalLevel * 2;
            
            // Экстремальные CSS фильтры на канвас
            // Контраст, Сатурация, Инверсия, Блюр
            const contrast = 100 + (shakalLevel * 50); // до 600%
            const saturate = 100 + (shakalLevel * 100); // до 1100%
            const hue = shakalLevel * 15; // вращение цвета
            const blur = shakalLevel * 0.5;

            let filterString = `contrast(${contrast}%) saturate(${saturate}%) hue-rotate(${hue}deg) blur(${blur}px)`;
            
            if (shakalLevel > 8) {
                filterString += " invert(100%)"; // Полный ад на высоких уровнях
            }

            videoCanvas.style.filter = filterString;
            // Небольшая тряска канваса
            videoCanvas.style.transform = `translate(${noiseX}px, ${noiseY}px)`;
        } else {
            // Базовый ретро-фильтр если шакал на 0
            videoCanvas.style.filter = "sepia(100%) hue-rotate(50deg) saturate(300%) contrast(120%)";
            videoCanvas.style.transform = "none";
        }

        animationId = requestAnimationFrame(drawVideoFrame);
    }


    // --- ОБРАБОТЧИКИ ПОЛЗУНКОВ ---
    function updateDisplay(input, displayId, unit = '') {
        document.getElementById(displayId).textContent = input.value + unit;
    }

    document.getElementById('preGain').addEventListener('input', function() {
        updateDisplay(this, 'preGainVal');
        if (preGainNode) preGainNode.gain.value = this.value;
    });

    document.getElementById('distortion').addEventListener('input', function() {
        updateDisplay(this, 'distortionVal');
        updateDistortionCurve(parseInt(this.value));
    });

    document.getElementById('limiterThresh').addEventListener('input', function() {
        updateDisplay(this, 'limiterThreshVal', 'dB');
        if (limiterNode) limiterNode.threshold.value = this.value;
    });

    document.getElementById('playbackRate').addEventListener('input', function() {
        updateDisplay(this, 'playbackRateVal', 'x');
        sourceVideo.playbackRate = this.value;
    });

    document.getElementById('videoShakal').addEventListener('input', function() {
        updateDisplay(this, 'videoShakalVal');
        // Эффект применяется в цикле drawVideoFrame
    });

    // EQ слайдеры
    document.querySelectorAll('.eq-slider').forEach((slider, index) => {
        slider.addEventListener('input', function() {
            this.nextElementSibling.textContent = (this.value > 0 ? '+' : '') + this.value + 'dB';
            if (eqBands[index]) {
                eqBands[index].gain.value = this.value;
            }
        });
    });

    // --- ЗАПИСЬ И СКАЧИВАНИЕ (ЭКСПЕРИМЕНТАЛЬНО) ---
    startRecBtn.addEventListener('click', startRecording);
    stopRecBtn.addEventListener('click', stopRecording);

    function startRecording() {
        if (!isPlaying) {
            alert("СНАЧАЛА ЗАПУСТИТЕ ВОСПРОИЗВЕДЕНИЕ (PLAY)!");
            return;
        }

        recordedChunks = [];
        let finalStream;

        // 1. Берем обработанный аудио поток
        const audioStream = destinationStreamNode.stream;

        if (isVideo) {
             // 2. Если видео, берем поток с канваса (25 FPS для производительности)
            const canvasStream = videoCanvas.captureStream(25);
            // 3. Объединяем аудио и видео
            finalStream = new MediaStream([...canvasStream.getVideoTracks(), ...audioStream.getAudioTracks()]);
        } else {
            // Только аудио
            finalStream = audioStream;
        }

        // Пробуем разные кодеки, т.к. поддержка в браузерах разная
        let options = { mimeType: isVideo ? 'video/webm;codecs=vp9,opus' : 'audio/webm;codecs=opus' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
             options = { mimeType: isVideo ? 'video/webm' : 'audio/webm' };
             if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                  options = {}; // Браузер сам выберет
             }
        }

        try {
            mediaRecorder = new MediaRecorder(finalStream, options);
        } catch (e) {
            alert("ОШИБКА ЗАПИСИ: БРАУЗЕР НЕ ПОДДЕРЖИВАЕТ ЭТОТ ФОРМАТ.");
            console.error(e);
            return;
        }

        mediaRecorder.ondataavailable = handleDataAvailable;
        mediaRecorder.onstop = handleStopRecording;
        mediaRecorder.start();

        startRecBtn.style.display = 'none';
        stopRecBtn.style.display = 'inline-block';
        recordingIndicator.style.display = 'inline-block';
        console.log("RECORDING STARTED...");
    }

    function handleDataAvailable(event) {
        if (event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            startRecBtn.style.display = 'inline-block';
            stopRecBtn.style.display = 'none';
            recordingIndicator.style.display = 'none';
            console.log("RECORDING STOPPED. PREPARING DOWNLOAD...");
        }
    }

    function handleStopRecording() {
        const blob = new Blob(recordedChunks, {
            type: isVideo ? 'video/webm' : 'audio/webm'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        document.body.appendChild(a);
        a.style = 'display: none';
        a.href = url;
        const fileExt = isVideo ? 'webm' : 'webm'; // WebM контейнер универсален для записи в браузере
        a.download = `shakalized_${new Date().getTime()}.${fileExt}`;
        a.click();
        window.URL.revokeObjectURL(url);
        console.log("DOWNLOAD INITIATED.");
    }

</script>

</body>
</html>
